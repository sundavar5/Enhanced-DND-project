<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D AI Dungeon Master ‚Äì Sectioned Version</title>

    <!--
    ========================================================================
    AI EDITING GUIDE (FOR CLAUDE / OTHER MODELS)
    ========================================================================
    - This file is split into numbered sections (1‚Äì11) that roughly match:
        1. Core HTML structure & CSS
        2. Game engine architecture (high-level data + helpers)
        3. Character system
        4. World & time system
        5. Event / encounter engine (AI calls, openers, turns)
        6. UI layout (screens, cards, log, inputs)
        7. Combat framework (high-level flags + enemies, DM-driven)
        8. Inventory & item architecture
        9. Quest engine (dialogue stub-ready)
        10. Dice + skill checks
        11. State management (localStorage, import/export, bootstrapping)

    - IMPORTANT FOR AI:
      * Do NOT change element IDs in the HTML unless you also update all JS
        references to those IDs.
      * When extending functionality, prefer adding code in the correct section
        instead of rewriting everything.
      * Keep the DeepSeek JSON protocol backwards-compatible:
          - You may ADD optional fields to the JSON schema.
          - Do NOT remove or rename existing ones without also updating the
            prompts and parsing logic.
      * Avoid adding functions into gameData (functions can‚Äôt be serialized to
        JSON cleanly for saving).

    - If you add new systems:
        - Add a new SECTION comment (e.g. "SECTION 12: Map / Navigation").
        - Document how it should be extended by future AIs.

    ========================================================================
    SECTION 1: CORE HTML STRUCTURE & CSS (UI FRAMEWORK)
    ========================================================================
    - Claude: Treat this as the visual framework. You may tweak styles, but try
      to keep the overall layout (two main columns: character/left, log/right).
    - If you add new panels (e.g. Quest log, Roll history), follow the same
      ‚Äúcard‚Äù visual language.
    -->

    <style>
/* Reset and Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --slate-50: #f8fafc;
    --slate-100: #f1f5f9;
    --slate-200: #e2e8f0;
    --slate-300: #cbd5e1;
    --slate-400: #94a3b8;
    --slate-500: #64748b;
    --slate-600: #475569;
    --slate-700: #334155;
    --slate-800: #1e293b;
    --slate-900: #0f172a;

    --blue-400: #60a5fa;
    --blue-500: #3b82f6;
    --blue-600: #2563eb;
    --blue-700: #1d4ed8;
    --blue-900: #1e3a8a;

    --red-400: #f87171;
    --red-500: #ef4444;
    --red-600: #dc2626;

    --purple-400: #c084fc;
    --purple-500: #a855f7;
    --purple-900: #581c87;

    --green-400: #4ade80;
    --green-500: #22c55e;

    --yellow-400: #facc15;
    --orange-400: #fb923c;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    background-color: var(--slate-900);
    color: white;
    line-height: 1.6;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem;
}

.hidden {
    display: none !important;
}

.card {
    background-color: var(--slate-800);
    border: 1px solid var(--slate-700);
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.grid {
    display: grid;
    gap: 1rem;
}

.grid-cols-2 {
    grid-template-columns: repeat(2, 1fr);
}

.grid-cols-3 {
    grid-template-columns: repeat(3, 1fr);
}

@media (min-width: 1024px) {
    .lg-grid-cols-3 {
        grid-template-columns: 1fr 2fr;
    }
}

.stat-box {
    background-color: var(--slate-700);
    border: 1px solid var(--slate-600);
    border-radius: 0.5rem;
    padding: 0.75rem;
    text-align: center;
}

.stat-label {
    font-size: 0.75rem;
    color: var(--slate-400);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.25rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
}

.input-group {
    margin-bottom: 1rem;
}

.input-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--slate-300);
    margin-bottom: 0.5rem;
}

.input-group input,
.input-group select,
.input-group textarea {
    width: 100%;
    background-color: var(--slate-700);
    border: 1px solid var(--slate-600);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
}

.input-group input:focus,
.input-group select:focus,
.input-group textarea:focus {
    outline: none;
    border-color: var(--blue-500);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 0.375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.875rem;
}

.btn-primary {
    background-color: var(--blue-600);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background-color: var(--blue-700);
}

.btn-secondary {
    background-color: var(--slate-700);
    color: white;
    border: 1px solid var(--slate-600);
}

.btn-secondary:hover:not(:disabled) {
    background-color: var(--slate-600);
}

.btn-danger {
    background-color: var(--red-600);
    color: white;
}

.btn-danger:hover:not(:disabled) {
    background-color: var(--red-500);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.message-user {
    background-color: rgba(30, 58, 138, 0.3);
    border-left: 3px solid var(--blue-500);
    padding: 0.75rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
}

.message-assistant {
    background-color: rgba(88, 28, 135, 0.3);
    border-left: 3px solid var(--purple-500);
    padding: 0.75rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
}

.message-system {
    background-color: rgba(51, 65, 85, 0.5);
    border-left: 3px solid var(--slate-400);
    padding: 0.75rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
}

.message-role {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--slate-400);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
}

.message-content {
    color: var(--slate-100);
    white-space: pre-wrap;
    word-wrap: break-word;
}

.inventory-item {
    background-color: var(--slate-700);
    border: 1px solid var(--slate-600);
    padding: 0.75rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 0.5rem;
}

.inventory-item:hover {
    background-color: var(--slate-600);
    border-color: var(--blue-500);
}

.rarity-common { border-left: 3px solid var(--slate-400); }
.rarity-uncommon { border-left: 3px solid var(--green-400); }
.rarity-rare { border-left: 3px solid var(--blue-400); }
.rarity-veryrare { border-left: 3px solid var(--purple-400); }
.rarity-legendary { border-left: 3px solid var(--orange-400); }
.rarity-artifact { border-left: 3px solid var(--red-400); }
.rarity-unique { border-left: 3px solid var(--yellow-400); }

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 50;
    padding: 1rem;
}

.modal-content {
    background-color: var(--slate-800);
    border: 1px solid var(--slate-700);
    border-radius: 0.5rem;
    padding: 1.5rem;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.modal-close {
    background: none;
    border: none;
    color: var(--slate-400);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 2rem;
    height: 2rem;
}

.modal-close:hover {
    color: white;
}

.property-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--slate-700);
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--slate-600);
    border-top-color: var(--purple-500);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 1rem auto;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.log-container {
    height: 400px;
    overflow-y: auto;
    margin-bottom: 1rem;
    padding-right: 0.5rem;
}

.flex {
    display: flex;
}

.gap-2 {
    gap: 0.5rem;
}

.flex-wrap {
    flex-wrap: wrap;
}

.mb-4 {
    margin-bottom: 1rem;
}

.text-center {
    text-align: center;
}

.color-red { color: var(--red-400); }
.color-blue { color: var(--blue-400); }
.color-green { color: var(--green-400); }
.color-yellow { color: var(--yellow-400); }
.color-purple { color: var(--purple-400); }
.color-orange { color: var(--orange-400); }
.color-white { color: white; }
.color-gray { color: var(--slate-400); }
.text-bold { font-weight: 700; }
.text-italic { font-style: italic; }
.text-underline { text-decoration: underline; }

::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: var(--slate-800);
}

::-webkit-scrollbar-thumb {
    background: var(--slate-600);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--slate-500);
}

.text-sm {
    font-size: 0.875rem;
}

.text-xs {
    font-size: 0.75rem;
}

.enemy-card {
    background-color: var(--slate-700);
    border: 1px solid var(--red-500);
    border-radius: 0.5rem;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
}

.badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
}

.badge-combat {
    background-color: var(--red-500);
}

.badge-turn {
    background-color: var(--yellow-400);
    color: var(--slate-900);
}

.badge-rarity {
    background-color: var(--slate-600);
    text-transform: capitalize;
}

.quest-item {
    background-color: var(--slate-700);
    border-radius: 0.5rem;
    border: 1px solid var(--slate-600);
    padding: 0.5rem 0.75rem;
    margin-bottom: 0.5rem;
}

/* scrollbars */
::-webkit-scrollbar-thumb:hover {
    background: var(--slate-500);
}
    </style>
</head>
<body>
    <!--
    ========================================================================
    SECTION 6: UI LAYOUT ‚Äì SCREENS & CARDS
    ========================================================================
    Claude:
      - The structure below defines 3 main screens:
        1) API Setup
        2) Character Creation
        3) Main Game
      - The main game is split into:
          * Left: Character sheet + currency + inventory + quests
          * Right: Location, enemies, log, action input
      - Any new UI panels should follow the same ‚Äúcard + heading‚Äù style.
    -->

    <!-- API Setup Screen -->
    <div id="apiSetup" class="container" style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 500px; width: 100%;">
            <h1 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">D&D AI Dungeon Master</h1>
            <p style="color: var(--slate-300); margin-bottom: 1.5rem; text-align: center;">
                Enter your DeepSeek API credentials to begin your adventure
            </p>

            <form id="apiForm">
                <div class="input-group">
                    <label>API Key</label>
                    <input type="password" id="apiKey" placeholder="sk-..." required>
                </div>

                <div class="input-group">
                    <label>Base URL (Optional)</label>
                    <input type="text" id="baseURL" value="https://api.deepseek.com" placeholder="https://api.deepseek.com">
                </div>

                <div class="input-group">
                    <label>Model</label>
                    <input type="text" id="model" value="deepseek-chat" placeholder="deepseek-chat">
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Start Adventure</button>
            </form>

            <p style="font-size: 0.75rem; color: var(--slate-400); margin-top: 1rem; text-align: center;">
                Your API key is stored locally and never sent anywhere except to your configured API endpoint.
            </p>
        </div>
    </div>

    <!-- Character Creation Screen -->
    <div id="characterCreation" class="container hidden" style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 600px; width: 100%;">
            <h1 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">Create Your Character</h1>

            <form id="characterForm">
                <div class="input-group">
                    <label>Character Name</label>
                    <input type="text" id="charName" placeholder="Enter character name" required>
                </div>

                <div class="grid grid-cols-2">
                    <div class="input-group">
                        <label>Race</label>
                        <select id="charRace">
                            <option>Human</option>
                            <option>Elf</option>
                            <option>Dwarf</option>
                            <option>Halfling</option>
                            <option>Dragonborn</option>
                            <option>Tiefling</option>
                            <option>Half-Elf</option>
                            <option>Half-Orc</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Class</label>
                        <select id="charClass">
                            <option>Fighter</option>
                            <option>Wizard</option>
                            <option>Rogue</option>
                            <option>Cleric</option>
                            <option>Ranger</option>
                            <option>Paladin</option>
                            <option>Barbarian</option>
                            <option>Bard</option>
                            <option>Warlock</option>
                            <option>Sorcerer</option>
                        </select>
                    </div>
                </div>

                <div class="input-group">
                    <label>Starting Level</label>
                    <select id="charLevel">
                        <option value="1">Level 1</option>
                        <option value="2">Level 2</option>
                        <option value="3">Level 3</option>
                        <option value="4">Level 4</option>
                        <option value="5">Level 5</option>
                        <option value="6">Level 6</option>
                        <option value="7">Level 7</option>
                        <option value="8">Level 8</option>
                        <option value="9">Level 9</option>
                        <option value="10">Level 10</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Backstory</label>
                    <textarea id="charBackstory" rows="4" placeholder="Tell us about your character's history, motivations, and personality..." required></textarea>
                    <p style="font-size: 0.75rem; color: var(--slate-400); margin-top: 0.25rem;">
                        The AI will use your backstory to generate appropriate starting equipment and currency
                    </p>
                </div>

                <div class="input-group">
                    <label>Adventure Setting</label>
                    <select id="setting">
                        <option value="classic-fantasy">Classic Fantasy</option>
                        <option value="dark-fantasy">Dark Fantasy</option>
                        <option value="high-fantasy">High Fantasy</option>
                        <option value="urban-fantasy">Urban Fantasy</option>
                        <option value="steampunk">Steampunk</option>
                    </select>
                </div>

                <div class="grid grid-cols-2">
                    <div class="input-group">
                        <label>Tone</label>
                        <select id="tone">
                            <option value="serious">Serious</option>
                            <option value="balanced" selected>Balanced</option>
                            <option value="lighthearted">Lighthearted</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Difficulty</label>
                        <select id="difficulty">
                            <option value="easy">Easy</option>
                            <option value="medium" selected>Medium</option>
                            <option value="hard">Hard</option>
                            <option value="deadly">Deadly</option>
                        </select>
                    </div>
                </div>

                <div class="input-group">
                    <label>Adventure Pacing</label>
                    <select id="pacing">
                        <option value="slow">Slow & Story-Rich</option>
                        <option value="moderate" selected>Moderate</option>
                        <option value="fast">Fast & Action-Packed</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Begin Adventure</button>
            </form>
        </div>
    </div>

    <!-- Initialization Screen -->
    <div id="initScreen" class="container hidden" style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
        <div class="card text-center" style="max-width: 500px;">
            <div class="spinner"></div>
            <p style="font-size: 1.125rem; color: var(--slate-300); margin-top: 1rem;">Preparing your adventure...</p>
            <p style="font-size: 0.875rem; color: var(--slate-400); margin-top: 0.5rem;">Generating starting equipment and currency based on your backstory</p>
        </div>
    </div>

    <!-- Main Game Screen -->
    <div id="gameScreen" class="container hidden">
        <header style="margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <div style="flex: 1;"></div>
                <h1 style="text-align: center; font-size: 1.5rem; font-weight: bold;">D&D - AI Dungeon Master</h1>
                <div style="flex: 1; display: flex; justify-content: flex-end;">
                    <div style="position: relative;">
                        <button id="saveMenuBtn" class="btn btn-secondary">Save Menu</button>
                        <div id="saveMenu" class="hidden" style="position: absolute; right: 0; margin-top: 0.5rem; background-color: var(--slate-800); border: 1px solid var(--slate-700); border-radius: 0.5rem; padding: 0.5rem; min-width: 150px; z-index: 10;">
                            <button id="exportBtn" class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem;">Export Save</button>
                            <button id="importBtn" class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem;">Import Save</button>
                            <button id="newGameBtn" class="btn btn-danger" style="width: 100%;">New Game</button>
                            <input type="file" id="importFile" accept=".json" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
            <p id="headerInfo" style="text-align: center; color: var(--slate-300);"></p>
        </header>

        <div class="grid lg-grid-cols-3">
            <!-- Left Column: Character Sheet + Currency + Inventory + Quests -->
            <div>
                <div class="card">
                    <h2 id="charSheetName" style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;"></h2>
                    <p id="charSheetInfo" style="font-size: 0.875rem; color: var(--slate-300); margin-bottom: 1rem;"></p>

                    <div class="grid grid-cols-2" style="margin-bottom: 1rem;">
                        <div class="stat-box">
                            <div class="stat-label">HP</div>
                            <div id="hpDisplay" class="stat-value" style="color: var(--red-400);"></div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">AC</div>
                            <div id="acDisplay" class="stat-value" style="color: var(--blue-400);"></div>
                        </div>
                    </div>

                    <div>
                        <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--slate-300); margin-bottom: 0.5rem; text-transform: uppercase;">Ability Scores</h3>
                        <div class="grid grid-cols-3" id="statsGrid"></div>
                        <p id="passivePerception" style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--slate-300);">
                            <!-- Passive perception will be injected here -->
                        </p>
                    </div>
                </div>

                <div class="card">
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.75rem;">Currency</h3>
                    <div class="grid grid-cols-2" id="currencyDisplay"></div>
                </div>

                <div class="card">
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.75rem;">Inventory</h3>
                    <div id="inventoryList"></div>
                </div>

                <!-- SECTION 9 (UI PART): Quest log panel -->
                <div class="card">
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.75rem;">Quests</h3>
                    <div id="questList"></div>
                </div>

                <!-- SECTION 10 (UI PART): Roll History panel -->
                <div class="card">
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.75rem;">Roll History</h3>
                    <div id="rollHistoryList"></div>
                </div>
            </div>

            <!-- Right Column: World / Combat / Log -->
            <div>
                <!-- SECTION 7 (UI PART): Combat status + enemies -->
                <div id="locationCard" class="card hidden">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="font-size: 0.875rem; color: var(--slate-400); text-transform: uppercase; letter-spacing: 0.05em;">Current Location</p>
                            <p id="locationName" style="font-size: 1.125rem; font-weight: 600; color: var(--blue-400);"></p>
                        </div>
                        <span id="combatBadge" class="badge badge-combat hidden">‚öîÔ∏è IN COMBAT</span>
                    </div>
                </div>

                <div id="enemiesCard" class="card hidden">
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--red-400);">Enemies</h3>
                    <div id="enemiesList"></div>
                </div>

                <!-- Adventure Log & Actions -->
                <div class="card">
                    <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">Adventure Log</h2>

                    <div class="log-container" id="messageLog"></div>

                    <div class="flex gap-2 flex-wrap mb-4">
                        <button id="rollD20Btn" class="btn btn-secondary">üé≤ Roll D20</button>
                        <button id="rollAdvBtn" class="btn btn-secondary" style="background-color: var(--green-500);">‚ÜóÔ∏è Advantage</button>
                        <button id="rollDisBtn" class="btn btn-secondary" style="background-color: var(--red-500);">‚ÜòÔ∏è Disadvantage</button>
                        <button id="perceptionBtn" class="btn btn-secondary">Perception Check</button>
                    </div>

                    <div style="display: flex; gap: 0.5rem;">
                        <textarea id="actionInput" placeholder="Describe your action..." style="flex: 1; min-height: 100px; background-color: var(--slate-700); border: 1px solid var(--slate-600); color: white; padding: 0.5rem; border-radius: 0.375rem; resize: vertical;"></textarea>
                        <button id="sendBtn" class="btn btn-primary" style="align-self: flex-end; padding: 0.5rem 1rem;">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Item Modal -->
    <div id="itemModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="itemModalTitle" style="font-size: 1.25rem; font-weight: bold;"></h3>
                <button id="itemModalClose" class="modal-close">√ó</button>
            </div>
            <div id="itemModalBody"></div>
        </div>
    </div>

    <!-- Quest Modal -->
    <div id="questModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="questModalTitle" style="font-size: 1.25rem; font-weight: bold;"></h3>
                <button id="questModalClose" class="modal-close">√ó</button>
            </div>
            <div id="questModalBody"></div>
        </div>
    </div>

    <script>
        // =====================================================================
        // SECTION 11: STATE MANAGEMENT SYSTEM (CORE GAME DATA + LOCALSTORAGE)
        // =====================================================================
        // Claude:
        //   - gameData is the central in-memory state.
        //   - All persistent fields should be serializable to JSON.
        //   - When you add new persistent fields, update:
        //       * loadSavedData()
        //       * persistGame()
        //       * export/import logic at the bottom
        //   - Do NOT store functions inside gameData.

        let gameData = {
            apiConfig: null,
            character: null,
            gameState: {
                inCombat: false,
                currentTurn: null,
                enemies: [],
                narrative: "",
                location: "Unknown",
                // SECTION 4 (WORLD/TIME): simple clock
                worldTime: { day: 1, hour: 8 }
            },
            adventurePreferences: null,
            messages: [],
            hasOpening: false,
            quests: [], // SECTION 9: quest list
            rollHistory: [] // SECTION 10: dice roll history
        };

        function safeParse(json) {
            try {
                return JSON.parse(json);
            } catch {
                return null;
            }
        }

        function loadSavedData() {
            const savedApi = localStorage.getItem('dnd_api_config');
            if (savedApi) gameData.apiConfig = safeParse(savedApi) || gameData.apiConfig;

            const savedChar = localStorage.getItem('dnd_character');
            if (savedChar) gameData.character = safeParse(savedChar) || gameData.character;

            const savedGame = localStorage.getItem('dnd_game_state');
            if (savedGame) {
                const parsed = safeParse(savedGame);
                if (parsed && typeof parsed === 'object') {
                    gameData.gameState = Object.assign({}, gameData.gameState, parsed);
                    if (!gameData.gameState.worldTime) {
                        gameData.gameState.worldTime = { day: 1, hour: 8 };
                    }
                }
            }

            const savedPrefs = localStorage.getItem('dnd_adventure_prefs');
            if (savedPrefs) gameData.adventurePreferences = safeParse(savedPrefs) || gameData.adventurePreferences;

            const savedMessages = localStorage.getItem('dnd_messages');
            if (savedMessages) gameData.messages = safeParse(savedMessages) || gameData.messages;

            const savedOpening = localStorage.getItem('dnd_has_opening');
            if (savedOpening) gameData.hasOpening = savedOpening === 'true';

            const savedQuests = localStorage.getItem('dnd_quests');
            if (savedQuests) gameData.quests = safeParse(savedQuests) || gameData.quests;

            const savedRolls = localStorage.getItem('dnd_roll_history');
            if (savedRolls) gameData.rollHistory = safeParse(savedRolls) || gameData.rollHistory;
        }

        function persistGame() {
            if (gameData.character) {
                localStorage.setItem('dnd_character', JSON.stringify(gameData.character));
            }
            localStorage.setItem('dnd_game_state', JSON.stringify(gameData.gameState));
            localStorage.setItem('dnd_messages', JSON.stringify(gameData.messages));
            localStorage.setItem('dnd_quests', JSON.stringify(gameData.quests || []));
            localStorage.setItem('dnd_roll_history', JSON.stringify(gameData.rollHistory || []));
        }

        // =====================================================================
        // SECTION 2: CORE UTILITIES & TEXT FORMATTING (ENGINE BASICS)
        // =====================================================================
        // Claude:
        //   - parseFormattedText maps simple markup to CSS classes.
        //   - You can add more tags here if needed (e.g. [spoiler][/spoiler]).
        //   - getModifier/formatModifier implement standard D&D 5e-style mods.

        function parseFormattedText(text) {
            if (!text) return text;

            // Bold italic
            text = text.replace(/\*\*\*(.*?)\*\*\*/g, '<span class="text-bold text-italic">$1</span>');
            // Bold
            text = text.replace(/\*\*(.*?)\*\*/g, '<span class="text-bold">$1</span>');
            // Italic
            text = text.replace(/\*(.*?)\*/g, '<span class="text-italic">$1</span>');
            // Underline
            text = text.replace(/__(.*?)__/g, '<span class="text-underline">$1</span>');
            // Strikethrough
            text = text.replace(/~~(.*?)~~/g, '<span style="text-decoration: line-through;">$1</span>');
            // Spoiler (hidden until hover)
            text = text.replace(/\[spoiler\](.*?)\[\/spoiler\]/g, '<span style="background-color: var(--slate-400); color: var(--slate-400); cursor: pointer;" onmouseover="this.style.color=&quot;white&quot;" onmouseout="this.style.color=&quot;var(--slate-400)&quot;">$1</span>');
            // Highlight
            text = text.replace(/\[highlight\](.*?)\[\/highlight\]/g, '<span style="background-color: rgba(250, 204, 21, 0.3); padding: 0.125rem 0.25rem; border-radius: 0.25rem;">$1</span>');
            // Colors
            text = text.replace(/\[red\](.*?)\[\/red\]/g, '<span class="color-red">$1</span>');
            text = text.replace(/\[blue\](.*?)\[\/blue\]/g, '<span class="color-blue">$1</span>');
            text = text.replace(/\[green\](.*?)\[\/green\]/g, '<span class="color-green">$1</span>');
            text = text.replace(/\[yellow\](.*?)\[\/yellow\]/g, '<span class="color-yellow">$1</span>');
            text = text.replace(/\[purple\](.*?)\[\/purple\]/g, '<span class="color-purple">$1</span>');
            text = text.replace(/\[orange\](.*?)\[\/orange\]/g, '<span class="color-orange">$1</span>');
            text = text.replace(/\[white\](.*?)\[\/white\]/g, '<span class="color-white">$1</span>');
            text = text.replace(/\[gray\](.*?)\[\/gray\]/g, '<span class="color-gray">$1</span>');

            return text;
        }

        function getModifier(stat) {
            return Math.floor((stat - 10) / 2);
        }

        function formatModifier(stat) {
            const mod = getModifier(stat);
            return mod >= 0 ? `+${mod}` : `${mod}`;
        }

        // =====================================================================
        // SECTION 3: CHARACTER SYSTEM (SHEET RENDERING + DERIVED STATS)
        // =====================================================================
        // Claude:
        //   - updateCharacterSheet() is the main render function for the left
        //     column (name, HP, AC, stats, currency, inventory, passive perception).
        //   - If adding new derived stats (e.g. proficiency, initiative), compute
        //     them here and render them in the DOM.

        function updateCharacterSheet() {
            const char = gameData.character;
            if (!char) return;

            const charNameEl = document.getElementById('charSheetName');
            const charInfoEl = document.getElementById('charSheetInfo');
            const hpEl = document.getElementById('hpDisplay');
            const acEl = document.getElementById('acDisplay');
            const headerInfoEl = document.getElementById('headerInfo');
            const statsGrid = document.getElementById('statsGrid');

            charNameEl.textContent = char.name;
            charInfoEl.textContent = `Level ${char.level} ${char.race} ${char.class}`;
            hpEl.textContent = `${char.hp}/${char.maxHp}`;
            acEl.textContent = char.ac;

            // World time in header (SECTION 4)
            const wt = gameData.gameState.worldTime;
            let timeText = '';
            if (wt) {
                const hh = String(wt.hour).padStart(2, '0');
                timeText = ` ‚Ä¢ Day ${wt.day}, ${hh}:00`;
            }

            headerInfoEl.textContent = `Playing as ${char.name} ‚Ä¢ Level ${char.level} ${char.race} ${char.class}${timeText}`;

            // Ability Scores
            statsGrid.innerHTML = '';
            const stats = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
            const statLabels = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
            
            stats.forEach((stat, i) => {
                const value = char.stats[stat];
                statsGrid.innerHTML += `
                    <div class="stat-box">
                        <div class="stat-label">${statLabels[i]}</div>
                        <div class="stat-value" style="font-size: 0.875rem;">
                            ${value}
                            <span style="font-size: 0.75rem; color: var(--slate-400); margin-left: 0.25rem;">
                                (${formatModifier(value)})
                            </span>
                        </div>
                    </div>
                `;
            });

            // Passive Perception (Wisdom-based)
            const wis = char.stats.wisdom || 10;
            const passive = 10 + getModifier(wis);

            // Proficiency Bonus (based on level)
            const proficiency = Math.ceil(char.level / 4) + 1;

            // Initiative (DEX-based)
            const dex = char.stats.dexterity || 10;
            const initiative = getModifier(dex);

            const passiveEl = document.getElementById('passivePerception');
            passiveEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem;">
                    <span>Passive Perception: ${passive}</span>
                    <span>Proficiency: +${proficiency}</span>
                    <span>Initiative: ${initiative >= 0 ? '+' + initiative : initiative}</span>
                </div>
            `;

            // SECTION 8: Currency + inventory rendering
            const currencyDisplay = document.getElementById('currencyDisplay');
            const cur = char.currency;
            currencyDisplay.innerHTML = `
                <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                    <span style="color: var(--yellow-400);">Gold:</span>
                    <span style="font-weight: 600;">${cur.gold}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                    <span style="color: var(--slate-300);">Silver:</span>
                    <span style="font-weight: 600;">${cur.silver}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                    <span style="color: var(--orange-400);">Copper:</span>
                    <span style="font-weight: 600;">${cur.copper}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                    <span style="color: var(--blue-400);">Platinum:</span>
                    <span style="font-weight: 600;">${cur.platinum}</span>
                </div>
            `;

            const inventoryList = document.getElementById('inventoryList');
            const inv = char.inventory || [];
            if (inv.length === 0) {
                inventoryList.innerHTML = '<p style="font-size: 0.875rem; color: var(--slate-400); text-align: center; padding: 1rem;">No items yet</p>';
            } else {
                inventoryList.innerHTML = inv.map((item, index) => {
                    const rarityClass = item.rarity ? `rarity-${item.rarity.toLowerCase().replace(/\s+/g, '')}` : 'rarity-common';
                    return `
                        <div class="inventory-item ${rarityClass}" onclick="showItemModal(${index})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <p style="font-weight: 500;">${item.name}</p>
                                    ${item.quantity > 1 ? `<p style="font-size: 0.75rem; color: var(--slate-400);">Quantity: ${item.quantity}</p>` : ''}
                                </div>
                                ${item.rarity ? `<span class="badge badge-rarity">${item.rarity}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            updateQuestList();
        }

        // =====================================================================
        // SECTION 9: QUEST ENGINE (UI + SIMPLE STORAGE)
        // =====================================================================
        // Claude:
        //   - Currently quests are just an array of objects stored in gameData.quests:
        //       { id, title, status, summary }
        //   - The AI DM may send quests in its JSON response; we render them here.
        //   - To add quest tracking logic (e.g. completion rules), add helpers that
        //     update gameData.quests and then call updateQuestList().

        function updateQuestList() {
            const questListEl = document.getElementById('questList');
            if (!questListEl) return;
            const quests = gameData.quests || [];

            if (quests.length === 0) {
                questListEl.innerHTML = '<p style="font-size: 0.875rem; color: var(--slate-400); text-align: center; padding: 0.75rem;">No active quests yet.</p>';
                return;
            }

            questListEl.innerHTML = quests.map((q, index) => {
                const status = (q.status || 'active').toLowerCase();
                let color = 'var(--yellow-400)';
                if (status === 'completed') color = 'var(--green-400)';
                if (status === 'failed') color = 'var(--red-400)';

                return `
                    <div class="quest-item" style="cursor: pointer;" onclick="showQuestModal(${index})">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.25rem;">
                            <span style="font-weight:500;">${q.title || 'Quest'}</span>
                            <span style="font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;color:${color};">
                                ${status}
                            </span>
                        </div>
                        ${q.summary ? `<p style="font-size:0.8rem;color:var(--slate-300);">${q.summary}</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        function showQuestModal(index) {
            const quests = gameData.quests || [];
            if (!quests[index]) return;
            const quest = quests[index];

            const modal = document.getElementById('questModal');
            const title = document.getElementById('questModalTitle');
            const body = document.getElementById('questModalBody');

            title.textContent = quest.title || 'Quest';

            const status = (quest.status || 'active').toLowerCase();
            let statusColor = 'var(--yellow-400)';
            if (status === 'completed') statusColor = 'var(--green-400)';
            if (status === 'failed') statusColor = 'var(--red-400)';

            let html = `
                <div class="property-row">
                    <span class="property-label">Status</span>
                    <span class="property-value" style="text-transform: uppercase; color: ${statusColor}; font-weight: 600;">${status}</span>
                </div>
            `;

            if (quest.summary) {
                html += `
                    <div style="margin-top: 1rem;">
                        <h4 style="font-size: 0.875rem; font-weight: 600; color: var(--slate-300); margin-bottom: 0.5rem;">Summary</h4>
                        <p style="font-size: 0.875rem; color: var(--slate-200);">${quest.summary}</p>
                    </div>
                `;
            }

            if (quest.description) {
                html += `
                    <div style="margin-top: 1rem;">
                        <h4 style="font-size: 0.875rem; font-weight: 600; color: var(--slate-300); margin-bottom: 0.5rem;">Details</h4>
                        <p style="font-size: 0.875rem; color: var(--slate-200);">${quest.description}</p>
                    </div>
                `;
            }

            if (quest.rewards) {
                html += `
                    <div style="margin-top: 1rem;">
                        <h4 style="font-size: 0.875rem; font-weight: 600; color: var(--slate-300); margin-bottom: 0.5rem;">Rewards</h4>
                        <p style="font-size: 0.875rem; color: var(--slate-200);">${quest.rewards}</p>
                    </div>
                `;
            }

            body.innerHTML = html;
            modal.classList.remove('hidden');
        }

        // =====================================================================
        // SECTION 10 (CONT.): ROLL HISTORY DISPLAY
        // =====================================================================
        // Claude:
        //   - updateRollHistory() renders recent dice rolls in a dedicated panel.
        //   - Roll history is capped at 20 entries and stored in gameData.rollHistory.

        function updateRollHistory() {
            const rollHistoryEl = document.getElementById('rollHistoryList');
            if (!rollHistoryEl) return;

            const rolls = gameData.rollHistory || [];
            if (rolls.length === 0) {
                rollHistoryEl.innerHTML = '<p style="font-size: 0.875rem; color: var(--slate-400); text-align: center; padding: 0.75rem;">No rolls yet.</p>';
                return;
            }

            rollHistoryEl.innerHTML = rolls.slice(0, 10).map(r => {
                let rollDisplay = r.rolls.join(', ');
                if (r.advantageMode === 'advantage' || r.advantageMode === 'disadvantage') {
                    const chosen = r.advantageMode === 'advantage' ? Math.max(...r.rolls) : Math.min(...r.rolls);
                    rollDisplay = `${r.rolls[0]}, ${r.rolls[1]} ‚Üí ${chosen}`;
                }
                const modText = r.modifier >= 0 ? `+${r.modifier}` : `${r.modifier}`;
                let advText = '';
                if (r.advantageMode === 'advantage') advText = ' (ADV)';
                if (r.advantageMode === 'disadvantage') advText = ' (DIS)';

                return `
                    <div style="font-size: 0.8rem; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-700);">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--slate-300);">${r.type}${advText}</span>
                            <span style="font-weight: 600; color: var(--blue-400);">${r.result}</span>
                        </div>
                        <div style="color: var(--slate-500); font-size: 0.75rem;">
                            [${rollDisplay}] ${modText}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // =====================================================================
        // SECTION 7: COMBAT FRAMEWORK (DISPLAY-LEVEL ONLY)
        // =====================================================================
        // Claude:
        //   - Combat is primarily managed by the AI DM (DeepSeek) via:
        //       gameData.gameState.inCombat
        //       gameData.gameState.enemies (name, hp, maxHp, ac)
        //       gameData.gameState.currentTurn (string name)
        //   - This function only RENDERS combat state. If you add local combat
        //     mechanics, they should still respect and sync with these fields.

        function updateGameState() {
            const state = gameData.gameState;
            const locationCard = document.getElementById('locationCard');
            const locationNameEl = document.getElementById('locationName');
            const combatBadge = document.getElementById('combatBadge');
            const enemiesCard = document.getElementById('enemiesCard');
            const enemiesList = document.getElementById('enemiesList');

            // Location
            if (state.location) {
                locationCard.classList.remove('hidden');
                locationNameEl.textContent = state.location;
            } else {
                locationCard.classList.add('hidden');
            }

            // Combat & enemies
            if (state.inCombat) {
                combatBadge.classList.remove('hidden');

                if (state.enemies && state.enemies.length > 0) {
                    enemiesCard.classList.remove('hidden');
                    enemiesList.innerHTML = state.enemies.map(enemy => `
                        <div class="enemy-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <p style="font-weight: 600;">${enemy.name}</p>
                                ${state.currentTurn === enemy.name ? '<span class="badge badge-turn">THEIR TURN</span>' : ''}
                            </div>
                            <div style="display: flex; gap: 1rem; font-size: 0.875rem;">
                                <span style="color: var(--slate-300);">AC ${enemy.ac}</span>
                                <span style="color: var(--red-400);">HP ${enemy.hp}/${enemy.maxHp}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    enemiesCard.classList.add('hidden');
                    enemiesList.innerHTML = '';
                }
            } else {
                combatBadge.classList.add('hidden');
                enemiesCard.classList.add('hidden');
                enemiesList.innerHTML = '';
            }

            // Refresh header/time via character sheet
            updateCharacterSheet();
        }

        // =====================================================================
        // SECTION 8: INVENTORY & ITEM ARCHITECTURE (MODAL + NORMALIZATION)
        // =====================================================================
        // Claude:
        //   - normalizeInventory() enforces quantity >= 1 and removes duplicate
        //     unique items (isUnique: true).
        //   - showItemModal() is read-only display; if you add item usage
        //     (consumption, equip/unequip), add a new UI path and update the
        //     inventory + re-render.

        function showItemModal(index) {
            const char = gameData.character;
            if (!char || !char.inventory) return;
            const item = char.inventory[index];
            if (!item) return;

            const modal = document.getElementById('itemModal');
            const title = document.getElementById('itemModalTitle');
            const body = document.getElementById('itemModalBody');

            title.textContent = item.name || 'Item';

            let html = '';
            if (item.rarity) html += `<div class="property-row"><span class="property-label">Rarity</span><span class="property-value" style="text-transform: capitalize;">${item.rarity}</span></div>`;
            if (item.type) html += `<div class="property-row"><span class="property-label">Type</span><span class="property-value">${item.type}</span></div>`;
            if (item.quantity > 1) html += `<div class="property-row"><span class="property-label">Quantity</span><span class="property-value">${item.quantity}</span></div>`;
            if (item.weight) html += `<div class="property-row"><span class="property-label">Weight</span><span class="property-value">${item.weight} lbs</span></div>`;
            if (item.value) html += `<div class="property-row"><span class="property-label">Value</span><span class="property-value">${item.value}</span></div>`;
            if (item.damage) html += `<div class="property-row"><span class="property-label">Damage</span><span class="property-value">${item.damage}</span></div>`;
            if (item.armorClass) html += `<div class="property-row"><span class="property-label">Armor Class</span><span class="property-value">${item.armorClass}</span></div>`;
            if (item.properties && item.properties.length > 0) html += `<div class="property-row"><span class="property-label">Properties</span><span class="property-value">${item.properties.join(', ')}</span></div>`;
            if (item.description) html += `<div style="margin-top: 1rem;"><h4 style="font-size: 0.875rem; font-weight: 600; color: var(--slate-300); margin-bottom: 0.5rem;">Description</h4><p style="font-size: 0.875rem; color: var(--slate-200);">${item.description}</p></div>`;
            if (item.magicalProperties) html += `<div style="margin-top: 1rem;"><h4 style="font-size: 0.875rem; font-weight: 600; color: var(--purple-400); margin-bottom: 0.5rem;">Magical Properties</h4><p style="font-size: 0.875rem; color: var(--slate-200);">${item.magicalProperties}</p></div>`;
            if (item.isUnique) html += `<div style="margin-top: 1rem; padding: 0.75rem; background-color: rgba(250, 204, 21, 0.2); border: 1px solid var(--yellow-400); border-radius: 0.5rem;"><p style="font-size: 0.875rem; color: var(--yellow-400); font-weight: 600;">‚ö° Unique Item - One of a kind</p></div>`;

            body.innerHTML = html || '<p>No details available.</p>';

            // Add use button for consumable items
            if (item.type) {
                const itemType = item.type.toLowerCase();
                if (itemType.includes('consumable') || itemType.includes('potion') || itemType.includes('scroll')) {
                    const useBtn = document.createElement('button');
                    useBtn.className = 'btn btn-primary';
                    useBtn.style.width = '100%';
                    useBtn.style.marginTop = '1rem';
                    useBtn.textContent = 'Use Item';
                    useBtn.onclick = () => {
                        useItem(index);
                        modal.classList.add('hidden');
                    };
                    body.appendChild(useBtn);
                }
            }

            modal.classList.remove('hidden');
        }

        function useItem(index) {
            const char = gameData.character;
            if (!char || !char.inventory) return;
            const item = char.inventory[index];
            if (!item) return;

            // Log usage
            gameData.messages.push({
                role: 'system',
                content: `You used: ${item.name}${item.description ? ' - ' + item.description : ''}`
            });

            // Decrease quantity or remove item
            if (item.quantity > 1) {
                char.inventory[index].quantity -= 1;
            } else {
                char.inventory.splice(index, 1);
            }

            persistGame();
            updateCharacterSheet();
            updateMessageLog();
        }

        function normalizeInventory(inventory) {
            if (!Array.isArray(inventory)) return [];
            const result = [];
            const uniqueSet = new Set();

            for (const raw of inventory) {
                const item = Object.assign({}, raw);
                if (item.quantity == null || item.quantity <= 0) item.quantity = 1;
                if (item.isUnique) {
                    const key = (item.name || '').toLowerCase();
                    if (uniqueSet.has(key)) {
                        // Skip duplicate unique item
                        continue;
                    }
                    uniqueSet.add(key);
                }
                result.push(item);
            }
            return result;
        }

        // =====================================================================
        // SECTION 5: EVENT / ENCOUNTER ENGINE (MESSAGES + AI DM CONNECTION)
        // =====================================================================
        // Claude:
        //   - updateMessageLog() renders conversation history (player + DM).
        //   - callAI() is the DeepSeek connector; both generateOpening() and
        //     sendAction() use it.
        //   - generateOpening() asks the DM for starting equipment + intro scene.
        //   - sendAction() sends each player action to the DM and applies JSON
        //     updates (stats, inventory, combat, quests, worldTime).

        function updateMessageLog() {
            const log = document.getElementById('messageLog');
            log.innerHTML = gameData.messages.map(msg => {
                let cls = 'message-assistant';
                if (msg.role === 'user') cls = 'message-user';
                else if (msg.role === 'system') cls = 'message-system';

                return `
                    <div class="${cls}">
                        <p class="message-role">${msg.role === 'user' ? 'You' : msg.role === 'system' ? 'System' : 'Dungeon Master'}</p>
                        <p class="message-content">${parseFormattedText(msg.content)}</p>
                    </div>
                `;
            }).join('');

            log.scrollTop = log.scrollHeight;
        }

        // =====================================================================
        // SECTION 10: DICE + SKILL CHECK SYSTEM
        // =====================================================================
        // Claude:
        //   - rollDice(sides) = simple RNG.
        //   - rollExpression(formula) currently handles "XdY+Z" (single term).
        //   - performSkillCheck(skillName) logs a system message with the result.
        //   - If you add advantage/disadvantage or multiple terms, expand
        //     rollExpression and adjust callers.

        function rollDice(sides) {
            return Math.floor(Math.random() * sides) + 1;
        }

        function rollExpression(formula, advantageMode = 'normal') {
            const trimmed = String(formula || '').trim();
            const match = trimmed.match(/^(\d*)d(\d+)([+-]\d+)?$/i);
            if (!match) {
                return { total: 0, rolls: [], modifier: 0, formula: trimmed, error: true };
            }
            const count = parseInt(match[1] || '1', 10);
            const size = parseInt(match[2], 10);
            const mod = match[3] ? parseInt(match[3], 10) : 0;
            const rolls = [];

            // Handle advantage/disadvantage for d20 rolls
            if (size === 20 && count === 1 && advantageMode !== 'normal') {
                const roll1 = rollDice(size);
                const roll2 = rollDice(size);
                rolls.push(roll1, roll2);
                const chosenRoll = advantageMode === 'advantage' ? Math.max(roll1, roll2) : Math.min(roll1, roll2);
                return {
                    total: chosenRoll + mod,
                    rolls: [roll1, roll2],
                    chosenRoll,
                    modifier: mod,
                    formula: trimmed,
                    advantageMode,
                    error: false
                };
            }

            // Normal rolling
            for (let i = 0; i < count; i++) {
                rolls.push(rollDice(size));
            }
            const sum = rolls.reduce((a, b) => a + b, 0);
            return { total: sum + mod, rolls, modifier: mod, formula: trimmed, advantageMode: 'normal', error: false };
        }

        function performSkillCheck(skillName, advantageMode = 'normal') {
            const char = gameData.character;
            if (!char || !char.stats) return;

            const skill = String(skillName || '').toLowerCase();
            let abilityKey = 'wisdom';
            let label = 'Skill Check';

            if (skill === 'perception') {
                abilityKey = 'wisdom';
                label = 'Perception Check';
            }

            const abilityScore = char.stats[abilityKey] || 10;
            const mod = getModifier(abilityScore);
            const roll = rollExpression('1d20', advantageMode);
            if (roll.error) return;

            const total = roll.total + mod;
            const modText = mod >= 0 ? `+${mod}` : `${mod}`;

            let message = `${label}`;
            if (advantageMode === 'advantage') {
                message += ` (Advantage): rolled ${roll.rolls[0]} and ${roll.rolls[1]}, chose ${roll.chosenRoll} ${modText} = ${total}`;
            } else if (advantageMode === 'disadvantage') {
                message += ` (Disadvantage): rolled ${roll.rolls[0]} and ${roll.rolls[1]}, chose ${roll.chosenRoll} ${modText} = ${total}`;
            } else {
                message += `: rolled ${roll.rolls[0]} ${modText} = ${total}`;
            }

            gameData.messages.push({ role: 'system', content: message });

            // Add to roll history
            gameData.rollHistory.unshift({
                type: label,
                result: total,
                rolls: roll.rolls,
                modifier: mod,
                advantageMode,
                timestamp: new Date().toISOString()
            });
            if (gameData.rollHistory.length > 20) {
                gameData.rollHistory = gameData.rollHistory.slice(0, 20);
            }

            updateMessageLog();
            updateRollHistory();
            persistGame();

            return { total, roll, mod };
        }

        // =====================================================================
        // SECTION 4: WORLD GENERATION / TIME SYSTEM (LIGHTWEIGHT)
        // =====================================================================
        // Claude:
        //   - worldTime = { day, hour } lives in gameData.gameState.
        //   - advanceWorldTime(hours) increments the clock; sendAction() calls it
        //     when the DM does not explicitly override worldTime.
        //   - The DM can also send a "worldTime" object in JSON.

        function advanceWorldTime(hours) {
            const wt = gameData.gameState.worldTime || { day: 1, hour: 8 };
            let totalHours = wt.day * 24 + wt.hour + hours;
            if (totalHours < 0) totalHours = 0;
            const day = Math.max(1, Math.floor(totalHours / 24));
            const hour = totalHours % 24;
            gameData.gameState.worldTime = { day, hour };
        }

        // =====================================================================
        // SECTION 2 (CONT.): AI CALL HELPER (DEEPSEEK CONNECTOR)
        // =====================================================================

        async function callAI(systemPrompt, userMessage) {
            const history = gameData.messages.slice(-10).map(function(msg) {
                return {
                    role: msg.role === 'system' ? 'system' : msg.role,
                    content: msg.content
                };
            });

            const base = (gameData.apiConfig.baseURL || '').replace(/\/+$/, '');
            let url;
            if (base.endsWith('/v1')) {
                url = `${base}/chat/completions`;
            } else {
                url = `${base}/v1/chat/completions`;
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${gameData.apiConfig.apiKey}`
                },
                body: JSON.stringify({
                    model: gameData.apiConfig.model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        ...history,
                        { role: 'user', content: userMessage }
                    ],
                    temperature: 0.8
                })
            });

            if (!response.ok) {
                throw new Error(`API request failed: ${response.status}`);
            }

            const data = await response.json();
            let content =
                (data.choices &&
                 data.choices[0] &&
                 data.choices[0].message &&
                 data.choices[0].message.content) ||
                '';
            content = content.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();

            return JSON.parse(content);
        }

        // =====================================================================
        // SECTION 5 (CONT.): OPENING GENERATION
        // =====================================================================

        async function generateOpening() {
            const char = gameData.character;
            const prefs = gameData.adventurePreferences;

            const systemPrompt = `You are an expert D&D Dungeon Master with complete control over the campaign.

You have FULL AUTHORITY to:
- Adjust character stats, HP, AC, inventory, and currency
- Grant starting equipment and money based on backstory and level
- Define the starting location and tone
- Set up initial quests

CHARACTER INFO:
- Name: ${char.name}
- Race: ${char.race}
- Class: ${char.class}
- Level: ${char.level}
- Backstory: ${char.backstory}

ADVENTURE PREFERENCES:
- Setting: ${prefs.setting}
- Tone: ${prefs.tone}
- Difficulty: ${prefs.difficulty}
- Pacing: ${prefs.pacing}

You MUST respond with a single JSON object with at least:
{
  "narrative": "Opening story text with optional formatting like **bold**, *italic*, [red]colored text[/red]...",
  "characterUpdates": {
    "inventory": [ ... full inventory ... ],
    "currency": {
      "gold": 0,
      "silver": 0,
      "copper": 0,
      "platinum": 0
    },
    "hp": 12,
    "maxHp": 12,
    "ac": 14,
    "stats": {
      "strength": 10,
      "dexterity": 10,
      "constitution": 10,
      "intelligence": 10,
      "wisdom": 10,
      "charisma": 10
    }
  },
  "location": "Starting location name"
}

You MAY ALSO include (optional but recommended):
- "inCombat": false,
- "enemies": [ { "name": "...", "hp": 10, "maxHp": 10, "ac": 12 } ],
- "quests": [
    {
      "id": "quest-1",
      "title": "Quest Title",
      "status": "active",
      "summary": "Short description of the quest."
    }
  ],
- "worldTime": { "day": 1, "hour": 8 }

Your ENTIRE response must be ONLY this JSON object, with no extra commentary.`;

            try {
                const aiResponse = await callAI(systemPrompt, "Generate starting equipment, currency, opening narrative, and (optionally) starting quests for this character.");

                // Character updates
                if (aiResponse.characterUpdates) {
                    if (aiResponse.characterUpdates.inventory) {
                        gameData.character.inventory = normalizeInventory(aiResponse.characterUpdates.inventory);
                    }
                    if (aiResponse.characterUpdates.currency) {
                        gameData.character.currency = Object.assign(
                            {},
                            gameData.character.currency,
                            aiResponse.characterUpdates.currency
                        );
                    }
                    if (aiResponse.characterUpdates.hp !== undefined) {
                        gameData.character.hp = aiResponse.characterUpdates.hp;
                    }
                    if (aiResponse.characterUpdates.maxHp !== undefined) {
                        gameData.character.maxHp = aiResponse.characterUpdates.maxHp;
                    }
                    if (aiResponse.characterUpdates.ac !== undefined) {
                        gameData.character.ac = aiResponse.characterUpdates.ac;
                    }
                    if (aiResponse.characterUpdates.stats) {
                        gameData.character.stats = Object.assign(
                            {},
                            gameData.character.stats,
                            aiResponse.characterUpdates.stats
                        );
                    }
                }

                // Game state
                if (aiResponse.location) gameData.gameState.location = aiResponse.location;
                if (aiResponse.inCombat !== undefined) gameData.gameState.inCombat = aiResponse.inCombat;
                if (Array.isArray(aiResponse.enemies)) gameData.gameState.enemies = aiResponse.enemies;
                if (aiResponse.worldTime) gameData.gameState.worldTime = aiResponse.worldTime;

                // Quests
                if (Array.isArray(aiResponse.quests)) {
                    gameData.quests = aiResponse.quests;
                    localStorage.setItem('dnd_quests', JSON.stringify(gameData.quests));
                }

                // Narrative
                gameData.messages.push({
                    role: 'assistant',
                    content: aiResponse.narrative
                });

                gameData.hasOpening = true;
                localStorage.setItem('dnd_has_opening', 'true');
                persistGame();

                // Show game screen
                document.getElementById('initScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.remove('hidden');
                updateCharacterSheet();
                updateGameState();
                updateMessageLog();
                updateRollHistory();

            } catch (error) {
                console.error('Error generating opening:', error);
                alert('Error generating opening. Please try again.');
                document.getElementById('initScreen').classList.add('hidden');
                document.getElementById('characterCreation').classList.remove('hidden');
            }
        }

        // =====================================================================
        // SECTION 5 (CONT.): MAIN ACTION LOOP ‚Äì PLAYER ‚Üí DM JSON ‚Üí UPDATES
        // =====================================================================

        async function sendAction(action) {
            const userMessage = { role: 'user', content: action };
            gameData.messages.push(userMessage);
            updateMessageLog();

            // Loading placeholder
            const log = document.getElementById('messageLog');
            log.innerHTML += '<div class="message-assistant"><p class="message-role">Dungeon Master</p><div class="spinner"></div></div>';
            log.scrollTop = log.scrollHeight;

            document.getElementById('sendBtn').disabled = true;
            document.getElementById('actionInput').disabled = true;

            const char = gameData.character;
            const state = gameData.gameState;

            const systemPrompt = `You are an expert D&D Dungeon Master with complete control over the campaign. You have FULL AUTHORITY to modify EVERYTHING:

CURRENT GAME STATE:
- Location: ${state.location}
- In Combat: ${state.inCombat}
- Enemies: ${JSON.stringify(state.enemies)}
- World Time: Day ${state.worldTime.day}, Hour ${state.worldTime.hour}

CHARACTER STATE:
- Name: ${char.name} (${char.race} ${char.class}, Level ${char.level})
- HP: ${char.hp}/${char.maxHp}
- AC: ${char.ac}
- Stats: STR ${char.stats.strength}, DEX ${char.stats.dexterity}, CON ${char.stats.constitution}, INT ${char.stats.intelligence}, WIS ${char.stats.wisdom}, CHA ${char.stats.charisma}
- Inventory: ${JSON.stringify(char.inventory)}
- Currency: ${char.currency.gold} GP, ${char.currency.silver} SP, ${char.currency.copper} CP, ${char.currency.platinum} PP

ACTIVE QUESTS:
${JSON.stringify(gameData.quests || [])}

ITEM MANAGEMENT RULES:
- When giving items, check current inventory (you are given the full array above)
- Unique items (legendary, artifacts, named relics, quest items) must set "isUnique": true, and use quantity 1
- Do NOT duplicate unique items: if the player already has a unique item by that name, do not add a second copy
- Stackable items (potions, ammunition, etc.) use the "quantity" field

RESPONSE FORMAT (JSON ONLY):
{
  "narrative": "Story description with formatting like **bold**, *italic*, [red]text[/red]",
  "characterUpdates": {
    "hp": 12,
    "maxHp": 12,
    "ac": 14,
    "stats": { ... full stat block ... },
    "inventory": [ ... full updated inventory ... ],
    "currency": { "gold":0, "silver":0, "copper":0, "platinum":0 }
  },
  "inCombat": false,
  "currentTurn": "Name whose turn it is, or null",
  "enemies": [ ... full enemy list if in combat ... ],
  "location": "Current location name",
  "worldTime": { "day": 1, "hour": 8 },
  "quests": [
    {
      "id": "quest-1",
      "title": "Quest Title",
      "status": "active/completed/failed",
      "summary": "Short quest summary"
    }
  ]
}

IMPORTANT:
- Always include characterUpdates even if values stay the same
- Always send the FULL inventory array
- Your ENTIRE response must be ONLY this JSON object.`;

            try {
                const aiResponse = await callAI(systemPrompt, action);

                // Character updates
                if (aiResponse.characterUpdates) {
                    const cu = aiResponse.characterUpdates;
                    if (cu.inventory) {
                        gameData.character.inventory = normalizeInventory(cu.inventory);
                    }
                    if (cu.currency) {
                        gameData.character.currency = cu.currency;
                    }
                    if (cu.hp !== undefined) {
                        gameData.character.hp = cu.hp;
                    }
                    if (cu.maxHp !== undefined) {
                        gameData.character.maxHp = cu.maxHp;
                    }
                    if (cu.ac !== undefined) {
                        gameData.character.ac = cu.ac;
                    }
                    if (cu.stats) {
                        gameData.character.stats = cu.stats;
                    }
                }

                // Game state
                if (aiResponse.location) gameData.gameState.location = aiResponse.location;
                if (aiResponse.inCombat !== undefined) gameData.gameState.inCombat = aiResponse.inCombat;
                if (aiResponse.currentTurn !== undefined) gameData.gameState.currentTurn = aiResponse.currentTurn;
                if (Array.isArray(aiResponse.enemies)) gameData.gameState.enemies = aiResponse.enemies;
                if (aiResponse.narrative) gameData.gameState.narrative = aiResponse.narrative;
                if (aiResponse.worldTime) {
                    gameData.gameState.worldTime = aiResponse.worldTime;
                } else {
                    // If DM doesn't override time, advance one hour per action
                    advanceWorldTime(1);
                }

                // Quests
                if (Array.isArray(aiResponse.quests)) {
                    gameData.quests = aiResponse.quests;
                }

                // Narrative message
                gameData.messages.push({
                    role: 'assistant',
                    content: aiResponse.narrative
                });

                persistGame();
                updateCharacterSheet();
                updateGameState();
                updateMessageLog();

            } catch (error) {
                console.error('Error:', error);
                gameData.messages.push({
                    role: 'assistant',
                    content: 'An error occurred while contacting the AI DM. Please try again.'
                });
                updateMessageLog();
            } finally {
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('actionInput').disabled = false;
            }
        }

        // =====================================================================
        // SECTION 3 (CONT.): CHARACTER CREATION HELPERS
        // =====================================================================

        function generateDefaultStatsForClass(className) {
            const base = {
                strength: 10,
                dexterity: 10,
                constitution: 10,
                intelligence: 10,
                wisdom: 10,
                charisma: 10
            };
            const c = (className || '').toLowerCase();

            if (c === 'fighter' || c === 'paladin' || c === 'barbarian') {
                base.strength = 15;
                base.constitution = 14;
                base.dexterity = 12;
            } else if (c === 'rogue' || c === 'ranger') {
                base.dexterity = 15;
                base.wisdom = 13;
                base.constitution = 13;
            } else if (c === 'wizard' || c === 'sorcerer' || c === 'warlock') {
                base.intelligence = c === 'wizard' ? 15 : 13;
                base.charisma = c === 'warlock' || c === 'sorcerer' ? 15 : 13;
                base.constitution = 13;
            } else if (c === 'cleric' || c === 'bard') {
                base.wisdom = c === 'cleric' ? 15 : 13;
                base.charisma = c === 'bard' ? 15 : 13;
                base.constitution = 13;
            }
            return base;
        }

        // =====================================================================
        // SECTION 6 (CONT.): EVENT LISTENERS & BOOTSTRAPPING
        // =====================================================================
        // Claude:
        //   - These listeners glue the UI to the engine.
        //   - If you add new buttons, wire them up here or near their section.

        document.getElementById('apiForm').addEventListener('submit', (e) => {
            e.preventDefault();
            gameData.apiConfig = {
                apiKey: document.getElementById('apiKey').value.trim(),
                baseURL: document.getElementById('baseURL').value.trim(),
                model: document.getElementById('model').value.trim()
            };
            localStorage.setItem('dnd_api_config', JSON.stringify(gameData.apiConfig));
            document.getElementById('apiSetup').classList.add('hidden');
            document.getElementById('characterCreation').classList.remove('hidden');
        });

        document.getElementById('characterForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const level = parseInt(document.getElementById('charLevel').value, 10);
            const cls = document.getElementById('charClass').value;
            const baseStats = generateDefaultStatsForClass(cls);

            gameData.character = {
                name: document.getElementById('charName').value,
                race: document.getElementById('charRace').value,
                class: cls,
                level: level,
                backstory: document.getElementById('charBackstory').value,
                hp: 8 + level * 5,
                maxHp: 8 + level * 5,
                ac: 10 + Math.floor(level / 2),
                stats: baseStats,
                inventory: [],
                currency: {
                    gold: 0,
                    silver: 0,
                    copper: 0,
                    platinum: 0
                }
            };

            gameData.adventurePreferences = {
                setting: document.getElementById('setting').value,
                tone: document.getElementById('tone').value,
                difficulty: document.getElementById('difficulty').value,
                pacing: document.getElementById('pacing').value
            };

            localStorage.setItem('dnd_character', JSON.stringify(gameData.character));
            localStorage.setItem('dnd_adventure_prefs', JSON.stringify(gameData.adventurePreferences));

            document.getElementById('characterCreation').classList.add('hidden');
            document.getElementById('initScreen').classList.remove('hidden');
            generateOpening();
        });

        document.getElementById('sendBtn').addEventListener('click', () => {
            const input = document.getElementById('actionInput');
            const action = input.value.trim();
            if (action) {
                input.value = '';
                sendAction(action);
            }
        });

        document.getElementById('actionInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('sendBtn').click();
            }
        });

        document.getElementById('rollD20Btn').addEventListener('click', () => {
            const result = rollExpression('1d20', 'normal');
            if (result.error) return;
            gameData.messages.push({
                role: 'system',
                content: `You roll a d20: ${result.rolls[0]}`
            });

            // Add to roll history
            gameData.rollHistory.unshift({
                type: 'D20 Roll',
                result: result.rolls[0],
                rolls: result.rolls,
                modifier: 0,
                advantageMode: 'normal',
                timestamp: new Date().toISOString()
            });
            if (gameData.rollHistory.length > 20) {
                gameData.rollHistory = gameData.rollHistory.slice(0, 20);
            }

            updateMessageLog();
            updateRollHistory();
            persistGame();
        });

        document.getElementById('rollAdvBtn').addEventListener('click', () => {
            const result = rollExpression('1d20', 'advantage');
            if (result.error) return;
            gameData.messages.push({
                role: 'system',
                content: `You roll a d20 with Advantage: rolled ${result.rolls[0]} and ${result.rolls[1]}, chose ${result.chosenRoll}`
            });

            // Add to roll history
            gameData.rollHistory.unshift({
                type: 'D20 Roll',
                result: result.chosenRoll,
                rolls: result.rolls,
                modifier: 0,
                advantageMode: 'advantage',
                timestamp: new Date().toISOString()
            });
            if (gameData.rollHistory.length > 20) {
                gameData.rollHistory = gameData.rollHistory.slice(0, 20);
            }

            updateMessageLog();
            updateRollHistory();
            persistGame();
        });

        document.getElementById('rollDisBtn').addEventListener('click', () => {
            const result = rollExpression('1d20', 'disadvantage');
            if (result.error) return;
            gameData.messages.push({
                role: 'system',
                content: `You roll a d20 with Disadvantage: rolled ${result.rolls[0]} and ${result.rolls[1]}, chose ${result.chosenRoll}`
            });

            // Add to roll history
            gameData.rollHistory.unshift({
                type: 'D20 Roll',
                result: result.chosenRoll,
                rolls: result.rolls,
                modifier: 0,
                advantageMode: 'disadvantage',
                timestamp: new Date().toISOString()
            });
            if (gameData.rollHistory.length > 20) {
                gameData.rollHistory = gameData.rollHistory.slice(0, 20);
            }

            updateMessageLog();
            updateRollHistory();
            persistGame();
        });

        document.getElementById('perceptionBtn').addEventListener('click', () => {
            performSkillCheck('perception');
            const input = document.getElementById('actionInput');
            input.value = 'I look around carefully.';
            input.focus();
        });

        document.getElementById('itemModalClose').addEventListener('click', () => {
            document.getElementById('itemModal').classList.add('hidden');
        });

        document.getElementById('itemModal').addEventListener('click', (e) => {
            if (e.target.id === 'itemModal') {
                document.getElementById('itemModal').classList.add('hidden');
            }
        });

        document.getElementById('questModalClose').addEventListener('click', () => {
            document.getElementById('questModal').classList.add('hidden');
        });

        document.getElementById('questModal').addEventListener('click', (e) => {
            if (e.target.id === 'questModal') {
                document.getElementById('questModal').classList.add('hidden');
            }
        });

        // Save menu
        document.getElementById('saveMenuBtn').addEventListener('click', () => {
            document.getElementById('saveMenu').classList.toggle('hidden');
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            const dataToSave = {
                character: gameData.character,
                gameState: gameData.gameState,
                adventurePreferences: gameData.adventurePreferences,
                messages: gameData.messages,
                quests: gameData.quests,
                rollHistory: gameData.rollHistory,
                hasOpening: gameData.hasOpening,
                timestamp: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dnd-save-${gameData.character ? gameData.character.name : 'character'}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('saveMenu').classList.add('hidden');
        });

        document.getElementById('importBtn').addEventListener('click', () => {
            document.getElementById('importFile').click();
            document.getElementById('saveMenu').classList.add('hidden');
        });

        document.getElementById('importFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const imported = JSON.parse(evt.target.result);
                    gameData.character = imported.character;
                    gameData.gameState = Object.assign({}, gameData.gameState, imported.gameState || {});
                    gameData.adventurePreferences = imported.adventurePreferences || null;
                    gameData.messages = imported.messages || [];
                    gameData.quests = imported.quests || [];
                    gameData.rollHistory = imported.rollHistory || [];
                    gameData.hasOpening = !!imported.hasOpening;
                    persistGame();
                    alert('Game loaded successfully!');
                    location.reload();
                } catch (error) {
                    alert('Error loading save file. Please make sure it\'s a valid save file.');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        });

        document.getElementById('newGameBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to start a new game? Current progress will be lost.')) {
                localStorage.clear();
                location.reload();
            }
        });

        // Bootstrapping
        loadSavedData();
        if (!gameData.apiConfig) {
            document.getElementById('apiSetup').classList.remove('hidden');
        } else if (!gameData.character) {
            document.getElementById('apiSetup').classList.add('hidden');
            document.getElementById('characterCreation').classList.remove('hidden');
        } else if (!gameData.hasOpening) {
            document.getElementById('apiSetup').classList.add('hidden');
            document.getElementById('initScreen').classList.remove('hidden');
            generateOpening();
        } else {
            document.getElementById('apiSetup').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            updateCharacterSheet();
            updateGameState();
            updateMessageLog();
            updateRollHistory();
        }
    </script>
</body>
</html>
